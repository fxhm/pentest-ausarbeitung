\begin{acronym}
\acro{LM}{LAN Manager}
\acro{PtH}{Pass-The-Hash}
\acro{NTLM}{New Technology LAN Manager}
\acro{RDP}{Remote Desktop Protocol}
\acro{SAM}{Security Account Manager}
\acro{AS}{Authentication Server}
\acro{TGS}{Ticket Granting Service}
\acro{TGT}{Ticket Granting Ticket}
\acro{KDC}{Key Distribution Center}
\acro{AD}{Active Directory}
\acro{ST}{Service Ticket}
\acro{KRBTGT}{Kerberos Ticket Granting Ticket}
\acro{SID}{Security Identifier}
\acro{SPN}{Service Principal Name}
\acro{RID}{Relative Identifier}
\end{acronym}

\subsection{Pass-The-Hash}

Um sich gegenüber einem Opfersystem zu authentifizieren, ist der Angreifer nicht unbedingt gezwungen, die Anmeldedaten eines bestehenden Benutzers durch die Brute-Force-Methode zu erlangen. Ein Beispiel für einen Angriff, der nicht der Brute-Force-Methode bedarf, ist die \ac{PtH}-Attacke. \ac{PtH} ist ein Angriff der vornehmlich gegen Windows-Systeme durchgeführt werden kann. Im Folgenden werden zunächst die Technologien vorgestellt, auf denen die Technik aufbaut, dann folgt eine genaue Beschreibung des Angriffs, sowie eine Vorstellung eines möglichen Angriffswerkzeugs.

\subsubsection{LAN Manager}
\ac{LM} (auch bekannt als LANMAN) ist ein Netzwerkbetriebssystem das in Microsoft-Betriebssystemen zum Einsatz kommt. Es dient zum Bereitstellen von Ressourcen (Laufwerke, Verzeichnisse, Drucker, serielle Geräte) im Netzwerk.
Zur Authentifizierung im Netzwerk werden Passwort-Hashes verwendet. Die eingesetzte Hashfunktion \emph{LM Hash} weist jedoch aus heutiger Sicht große Schwächen auf und ist mit Rainbow Tables innerhalb von Sekunden, mit der Brute-Force-Methode innerhalb weniger Stunden knackbar.
Ab Windows NT wurde LAN Manager durch \ac{NTLM} ersetzt. LAN Manager ist jedoch bis heute aus Legacy-Gründen in Microsoft-Betriebssystemen enthalten. Erst ab Windows Vista ist es standardmäßig deaktiviert.

\subsubsection{New Technology LAN Manager}
\ac{NTLM} ist ein Authentifizierungsverfahren für Rechnernetze, das ursprünglich properitär von Microsoft entwickelt wurde. Es ist der Nachfolger von LAN Manager und bis heute auch in modernen Computersystemen im Einsatz. Die in \ac{NTLM} eingesetzte Hashfunktion \emph{NTLM Hash} ist ähnlich schwach wie ihr Vorgänger. Mit moderner Hardware ist sie innerhalb weniger Stunden knackbar (Stand 2019: weniger als 2,5 Stunden für ein 8-Zeichen-Passwort).

\subsubsection{Der Pass-The-Hash-Angriff}
Pass-The-Hash ist ein Angriff, der es dem Angreifer ermöglicht, sich mit dem \ac{LM}- oder \ac{NTLM}-Hashwert eines Passworts gegenüber einem Server zu authentifizieren. Das Passwort im Klartext wird dazu nicht benötigt, somit erübrigt sich auch die rechenaufwendige Anwendung der Brute-Force-Methode zum Knacken des Passwort-Hashes. Verwundbar für den Angriff sind alle Systeme, die eine \ac{LM}- oder \ac{NTLM}-Authentifizierung akzeptieren. Um den Angriff durchführen zu können, muss jedoch erst ein \ac{LM}- oder \ac{NTLM}-Hashwert des Passworts, sowie der zugehörige Benutzername beschafft werden.

\paragraph{Beschaffung des Passwort-Hashes}

\begin{itemize}
\item Falls der Angreifer auf einem Windows-System über Administratorrechte verfügt, kann er die gecachten Hashwerte der Passwörter aller Nutzer auslesen, die sich auf dem System angemeldet haben (dies gilt auch für die Anmeldung über \ac{RDP} und Konsole). Diese Hashwerte befinden sich in der Datenbank des \ac{SAM}. Die Cache-Einstellungen lassen sich jedoch so ändern, dass diese Vorgehensweise nicht mehr erfolgreich ist.
\item Durch Dumping der \ac{SAM}-Datenbank des lokal angemeldeten Benutzers kann der Angreifer die Passwort-Hashes dieses lokalen Benutzers akquirieren.
\item Das Abhören des LAN Manager- bzw. \ac{NTLM}-Challenge-Response-Dialogs, der bei der Anmeldung durchgeführt wird, ermöglicht es dem Angreifer, an den verschlüsselten Hashwert eines Passworts zu gelangen. Diese Verschlüsselung kann wiederum mit Hilfe der Brute-Force-Methode gebrochen werden.
\item Der Angreifer hat auch die Möglichkeit, die Anmeldedaten von authentifizierten Benutzern aus dem Speicherauszug des \emph{lsass.exe}-Prozesses auszulesen. Auch hier können sich die Passwort-Hashes von über \ac{RDP} angemeldeten Benutzern befinden.
\end{itemize}

\subsubsection{pth-winexe}
Winexe ist ein Werkzeug um auf einem Zielrechner eine Remoteshell zu öffnen. Das Prefix ''pth'' weist darauf hin, dass zur Authentifizierung auf dem Zielrechner ein Pass-the-Hash-Angriff angewendet wird. Verwendung:
\begin{lstlisting}
Syntax
    pth-winexe [OPTION]... //HOST COMMAND
Parameter
    *@//HOST@*: Der Zielrechner
    *@COMMAND@*: der Befehl, der auf dem Zielrechner ausgeführt werden soll. 
\end{lstlisting}
Um eine Kommandozeile zu starten kann für \texttt{COMMAND} der Befehl \texttt{cmd} verwendet werden. Mit der Option \texttt{-{}-user} können die Anmeldedaten in folgender Syntax angegeben werden: \texttt{-{}-user=[DOMAIN/]USERNAME[\%PASSWORD]} Das Passwort entspricht dabei dem Passwort-Hash. \\
Beispiel: \texttt{pth-winexe -{}-user=root\%912c80:a38216 //192.168.178.20}

\subsection{Kerberos}

Kerberos ist ein verteilter Authentifizierungsdienst für Rechnernetze, der am MIT entwickelt wurde. Die erste Veröffentlichung erschien 1978, aktuell (Stand 2019) ist Kerberos 5. Auch Kerberos ist angreifbar und wird bei Attacken oft zum unbemerkten Fortbewegen im Opfernetzwerk, sowie zur Rechteausweitung verwendet. Im Folgenden soll zunächst auf den Protokollablauf eingegangen werden, um dann einige Angriffsszenarien zu erläutern.

\subsubsection{Protokollablauf}
\begin{figure}[H]
	\includegraphics[scale=0.2125]{Content/Bilder/kerberos}
	\caption{Die großen Rechtecke stellen die am Protokoll beteiligten Server dar. Die kleinen Rechtecke stellen Netzwerkpakete dar, wobei die Farbe eines Pakets den vorgesehenen endgültigen Empfänger des Pakets symbolisiert. In den Paketen ist nach dem Stern jeweils angegeben, mit welchem Schlüssel das Paket verschlüsselt wird.}
\end{figure}

\begin{enumerate}
\item Der Client sendet eine Nachricht, die lediglich seine Nutzer-ID \emph{u\_id} enthält, im Klartext and den \ac{AS}. Es wird hier also kein Passwort oder geheimer Schlüssel übertragen.
\item Der \ac{AS} sucht in der Datenbank nach der Nutzer-ID aus der eben erhaltenen Nachricht. Falls er sie findet, berechnet er den Hashwert des ebenfalls in der Datenbank enthaltenen Passworts des Nutzers. Der \ac{AS} schickt dann folgende Nachrichten an den Client:
\begin{itemize}
\item[A)] \ac{TGS}-Sitzungsschlüssel \emph{tgs\_session\_key}, verschlüsselt mit dem zuvor berechneten Hashwert des Nutzer-Passworts \emph{u\_key}.
\item[B)] \ac{TGT}, welches folgende Daten enthält: Nutzer-ID, Netzwerkadresse des Clients, Gültigkeitsdauer des \ac{TGT} und den \ac{TGS}-Sitz\-ungs\-schlüs\-sel \emph{tgs\_session\_key}. Dieses Paket ist mit dem geheimen Schlüssel des \ac{TGS} \emph{tgs\_key} verschlüsselt.
\end{itemize}
Nach Erhalt der beiden Pakete versucht der Client Paket A mit dem geheimen Schlüssel \emph{u\_key} zu entschlüsseln, den er aus dem Passwort berechnet, das der Nutzer eingegeben hat. Falls das durch den Nutzer eingegebene Passwort mit dem Passwort aus der Datenbank des \ac{AS} übereinstimmt, kann der Client das Paket entschlüsseln. Er erhält somit den \ac{TGS}-Sitzungsschlüssel \emph{tgs\_session\_key}. Nun hat der Client alle Informationen, die er braucht, um sich gegenüber dem \ac{TGS} zu authentifizieren.
\item  Sobald der Client einen Dienst anfragen will, muss er zur Vorbereitung dem \ac{TGS} folgende Nachrichten schicken:
\begin{itemize}
\item[C)] Paket, das aus dem immernoch verschlüsselten \ac{TGT} und der ID des angeforderten Services zusammengesetzt ist.
\item[D)] Authentifizierungspaket, das aus der Nutzer-ID \emph{u\_id} und einem Zeitstempel \emph{timestamp} besteht. Dieses Paket ist mit dem \ac{TGS}-Sitzungsschlüssel \emph{tgs\_session\_key} verschlüsselt.
\end{itemize}
Nach Erhalt dieser Pakete extrahiert der \ac{TGS} das \ac{TGT} aus Paket C. Das \ac{TGT} entschlüsselt er wiederum mit seinem geheimen Schlüssel \emph{tgs\_key}. Der \ac{TGS} erhält somit den \ac{TGS}-Sitzungsschlüssel \emph{tgs\_session\_key}, welchen er zum Entschlüsseln von Paket D verwendet. Er vergleicht nun die Nutzer-IDs aus den beiden erhaltenen Paketen. Falls diese übereinstimmen, war die Authentifizierung des Clients gegenüber dem \ac{TGS} erfolgreich.
\item Falls die Authentifizierung erfolgreich war, sendet der \ac{TGS} folgende Nachrichten zurück an den Client:

\begin{itemize}
\item[E)] Service-Ticket, welches die Nutzer-ID \emph{u\_id}, die Netzwerkadresse des Clients, eine Gültigkeitsdauer und den Service-Sitzungsschlüssel \emph{s\_session\_key} enthält. Dieses Paket ist mit dem geheimen Schlüssel des angefragten Service \emph{s\_key} verschlüsselt.
\item[F)] Service-Sitzungsschlüssel \emph{s\_session\_key}. Dieses Paket ist mit dem \ac{TGS}-\\Sitz\-ungs\-schlüs\-sel \emph{tgs\_session\_key} verschlüsselt.
\end{itemize}
Nach Erhalt dieser Pakete hat der Client alle Informationen, die er benötigt, um sich gegenüber dem Service Server zu authentifizieren.
\item Der Client sendet dem Service Server folgende Nachrichten:

\begin{itemize}
\item[E)] das Paket E aus 4)
\item[G)] Ein neues Authentifizierungspaket, das die Nutzer-ID \emph{u\_id} und einen Zeitstempel \emph{timestamp} enthält. Dieses Paket ist mit dem Service-Sitz\-ungs\-schlüs\-sel \emph{s\_session\_key} verschlüsselt.
\end{itemize}
Der Service Server entschlüsselt Paket E mit seinem eigenen geheimen Schlüssel \emph{s\_key}. Er erhält somit den Service-Sitzungsschlüssel \emph{s\_session\_key}, mit welchem er wiederum Paket G entschlüsselt. Falls die Nutzer-IDs aus Paket E und Paket G übereinstimmen, hat sich der Client erfolgreich gegenüber dem Service Server authentifiziert.
\item Zum Bestätigen der Authentifizierung sendet der Service Server dem Client folgendes Paket:

\begin{itemize}
\item[H)] Die Summe aus dem Zeitstempel \emph{timestamp} aus Paket G und dem Wert 1. Dieses Paket ist mit dem Service-Sitzungsschlüssel \emph{s\_session\_key} verschlüsselt.
\end{itemize}
Der Client entschlüsselt Paket H und vergleicht die enthaltene Summe mit seinem zuvor gesendeten Zeitstempel. Falls er das erwartete Ergebnis erhält, kann er dem Service Server vertrauen.

\end{enumerate}
\ac{AS} und \ac{TGS} bilden zusammen das \ac{KDC} und sind oft im selben Rechner untergebracht.


\subsubsection{Angriffsszenarien}
\paragraph{Golden Ticket}
Falls der Angreifer über volle Administratorrechte auf einem lokalen System verfügt, kann er sich alle Informationen beschaffen, um sich ein so genanntes ''Golden Ticket'' selbst auszustellen. Mit dem ''Golden Ticket'' ist es ihm möglich, sich in jedem Konto der Domäne anzumelden und somit unbemerkt fortzubewegen. Dazu benötigt er folgende Informationen:
\begin{enumerate}
\item Name der Zieldomäne
\item Die \ac{SID} der Zieldomäne
\item Den Namen des Nutzeraccounts, der imitiert werden soll
\item Die \ac{RID} des Nutzeraccounts, der imitiert werden soll
\item Die \acsp{RID} der Gruppen, zu denen der Account gehören soll
\item Einen oder mehrere Schlüssel des \ac{KRBTGT}
\end{enumerate}
\paragraph{Kerberoast}
Für den so genannten Kerberoast-Angriff benötigt der Angreifer lediglich Zugang zum Dienst \ac{AD}. Wenn er nun ein Service Ticket anfordert, kann er dieses in einer Offline-Attacke cracken und somit das Dienstpasswort im Klartext erhalten. Service Tickets sind mit dem \ac{NTLM}-Hashwert des Passworts des Services verschlüsselt und können daher leicht geknackt werden. Eine Kerberoast-Attacke besteht aus folgenden Schritten:
\begin{enumerate}
\item Den \ac{SPN} des anzugreifenden Dienstes herausfinden, bzw. das Netz nach Diensten und deren \ac{SPN} durchsuchen
\item Ein Service Ticket anfordern
\item Das Service Ticket exportieren
\item Das Service Ticket cracken (\ac{NTLM}-Hash cracken)
\item Mit dem \ac{NTLM}-Hash ein neu ausgestelltes Ticket für einen beliebigen Domänennutzer signieren und in den Speicher injizieren
\end{enumerate}
Mit dem Kerberoast-Angriff ist es auch möglich, eine Rechteausweitung (Privilege Escalation) zu erreichen, da ein neu erstellter Fake-Nutzer durch den Angreifer einer höher gestellten Gruppe zugeordnet werden kann.

Sowohl für den Golden Ticket-, als auch für den Kerberoast-Angriff ist das Werkzeug \emph{mimikatz} hilfreich.
